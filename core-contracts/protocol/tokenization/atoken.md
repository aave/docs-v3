# AToken

aTokens are tokens minted and burnt upon `supply` and `withdraw` of assets to an Aave market. aTokens denote the amount of crypto assets supplied to the protocol and the yield earned on those assets. The aTokensâ€™ value is pegged to the value of the corresponding supplied asset at a 1:1 ratio and can be safely stored, transferred or traded. All yield collected by the aTokens' reserves are distributed to aToken holders directly by continuously increasing their wallet balance.

This contract is the implementation of the interest bearing token for the Aave protocol. It inherits the [ScaledBalanceTokenBase](./base/scaledbalancetoken.md) and [EIP712Base](./base/eip712base.md) token contracts.

All standard EIP20 methods are implemented for aTokens, such as `balanceOf`, `transfer`, `transferFrom`, `approve`, `totalSupply` etc.

`balanceOf` will always return the most up to date balance of the user, which includes their principal balance and the yield generated by the principal balance.

## Write Methods

### initialize

```solidity
function initialize(
    IPool initializingPool,
    address treasury,
    address underlyingAsset,
    IAaveIncentivesController incentivesController,
    uint8 aTokenDecimals,
    string calldata aTokenName,
    string calldata aTokenSymbol,
    bytes calldata params
) external override initializer
```

Emitted when an aToken is initialized.

#### Input Parameters:

| Name                 | Type                        | Description                                                              |
| :------------------- | :-------------------------- | :----------------------------------------------------------------------- |
| initializingPool     | `IPool`                     | The address of the associated pool                    |
| treasury             | `address`                   | The address of the treasury |
| underlyingAsset      | `address`                   | The address of the underlying asset |
| incentivesController | `IAaveIncentivesController` | The address of the incentives controller for this aToken           |
| aTokenDecimals       | `uint8`                     | The decimals of the underlying asset   |
| aTokenName           | `string`                    | The name of the aToken                                      |
| aTokenSymbol         | `string`                    | The symbol of the aToken                                    |
| params               | `bytes`                     | A set of encoded parameters for additional initialization                |
 
### mint

```solidity
function mint(
    address caller,
    address onBehalfOf,
    uint256 amount,
    uint256 index
) external virtual override onlyPool returns (bool)
```

Mints `amount` aTokens to `user`.

#### Input Parameters:

| Name       | Type      | Description                                                                                                                      |
| :--------- | :-------- | :------------------------------------------------------------------------------------------------------------------------------- |
| caller       | `address` | The address performing the mint |
| onBehalfOf | `address` | The address of the user that will receive the minted aTokens                                                                                  |
| amount     | `uint256` | The amount of tokens getting minted                                                                                       |
| index      | `uint256` | The next liquidity index of the reserve                                                                                          |

#### Return Values:

| Type      | Description                                                        |
| :-------- | :----------------------------------------------------------------- |
| `bool`    | `true` if the the previous balance of the user was 0 |

### burn

```solidity
function burn(
    address from,
    address receiverOfUnderlying,
    uint256 amount,
    uint256 index
) external virtual override onlyPool 
```

Burns aTokens from `user` and sends the equivalent amount of underlying to `receiverOfUnderlying`.

In some instances, the mint event could be emitted from a burn transaction if the amount to burn is less than the interest that the user accrued.

#### Input Parameters:

| Name   | Type      | Description                                    |
| :----- | :-------- | :--------------------------------------------- |
| from   | `address` | The address from which the aTokens will be burned |
| receiverOfUnderlying   | `address` | The address that will receive the underlying asset |
| amount | `uint256` | The amount of tokens that will be burned  |
| index  | `uint256` | The next liquidity index of the reserve |

### mintToTreasury

```solidity
function mintToTreasury(uint256 amount, uint256 index) external override onlyPool 
```

Mints aTokens to the reserve treasury.

#### Input Parameters:

| Name   | Type      | Description                                    |
| :----- | :-------- | :--------------------------------------------- |
| amount   | `uint256` | The amount of tokens getting minted |
| index   | `uint256` | The address that will receive the underlying asset |

### transferOnLiquidation

```solidity
function transferOnLiquidation(
    address from,
    address to,
    uint256 value
) external override onlyPool
```

Transfers aTokens in the event of a borrow being liquidated, in case the liquidators reclaims the aToken.

#### Input Parameters:

| Name   | Type      | Description                                    |
| :----- | :-------- | :--------------------------------------------- |
| from   | `address` | The address getting liquidated, current owner of the aTokens |
| to   | `address` | The recipient of aTokens |
| value   | `uint256` | The amount of tokens getting transferred |

### transferUnderlyingTo

```solidity
function transferUnderlyingTo(address target, uint256 amount) external virtual override onlyPool 
```

Transfers the underlying asset to `target`.

Used by the `Pool` to transfer assets in borrow(), withdraw() and flashLoan()

#### Input Parameters:

| Name   | Type      | Description                                    |
| :----- | :-------- | :--------------------------------------------- |
| user   | `address` | The recipient of the underlying |
| amount   | `uint256` | The amount getting transferred |

### handleRepayment

```solidity
function handleRepayment(address user, uint256 amount) external virtual override onlyPool 
```

Handles the underlying received by the aToken after the transfer has been completed.

The default implementation is empty as with standard ERC20 tokens, nothing needs to be done after the transfer is concluded. However in the future there may be aTokens that allow for example to stake the underlying to receive LM rewards. In that case, `handleRepayment()` would perform the staking of the underlying asset.

#### Input Parameters:

| Name   | Type      | Description                                    |
| :----- | :-------- | :--------------------------------------------- |
| user   | `address` | The user executing the repayment |
| amount   | `uint256` | The amount getting repaid |

### permit

```solidity
function permit(
    address owner,
    address spender,
    uint256 value,
    uint256 deadline,
    uint8 v,
    bytes32 r,
    bytes32 s
) external override 
```

Allows a user to permit another account (or contract) to use their funds using a signed message. This enables gas-less transactions and single approval/transfer transactions. Allow passing a signed message to approve spending.

Implements the permit function as for https://github.com/ethereum/EIPs/blob/8a34d644aacf0f9f8f00815307fd7dd5da07655f/EIPS/eip-2612.md.

#### Input Parameters:

| Name   | Type      | Description                                    |
| :----- | :-------- | :--------------------------------------------- |
| owner   | `address` | The owner of the funds |
| spender   | `address` | The spender of the funds |
| value   | `uint256` | The amount the `spender` is permitted to spend |
| deadline   | `uint256` | The deadline timestamp, use `type(uint256).max` for max/no deadline |
| v   | `uint8` | The V signature parameter |
| r   | `bytes32` | The R signature parameter |
| s   | `bytes32` | The S signature parameter |

```jsx
import { signTypedData_v4 } from 'eth-sig-util'
import { fromRpcSig } from 'ethereumjs-util'
// ... other imports
import aTokenAbi from "./aTokenAbi.json"
// ... setup your web3 provider
const aTokenAddress = "ATOKEN_ADDRESS"
const aTokenContract = new web3.eth.Contract(aTokenAbi, aTokenAddress)
const privateKey = "YOUR_PRIVATE_KEY_WITHOUT_0x"
const chainId = 1
const owner = "OWNER_ADDRESS"
const spender = "SPENDER_ADDRESS"
const value = 100 // Amount the spender is permitted
const nonce = 1 // The next valid nonce, use `_nonces()`
const deadline = 1600093162
const permitParams = {
  types: {
    EIP712Domain: [
      { name: "name", type: "string" },
      { name: "version", type: "string" },
      { name: "chainId", type: "uint256" },
      { name: "verifyingContract", type: "address" },
    ],
    Permit: [
      { name: "owner", type: "address" },
      { name: "spender", type: "address" },
      { name: "value", type: "uint256" },
      { name: "nonce", type: "uint256" },
      { name: "deadline", type: "uint256" },
    ],
  },
  primaryType: "Permit",
  domain: {
    name: "aTOKEN_NAME",
    version: "1",
    chainId: chainId,
    verifyingContract: aTokenAddress,
  },
  message: {
    owner,
    spender,
    value,
    nonce,
    deadline,
  },
}
const signature = signTypedData_v4(
  Buffer.from(privateKey, "hex"),
  { data: permitParams }
)
// The signature can now be used to execute the transaction
const { v, r, s } = fromRpcSig(signature)
await aTokenContract.methods
    .permit({
      owner,
      spender,
      value,
      deadline,
      v,
      r,
      s
    })
    .send()
    .catch((e) => {
        throw Error(`Error permitting: ${e.message}`)
    })
```

### rescueTokens

```solidity
function rescueTokens(
    address token,
    address to,
    uint256 amount
) external override onlyPoolAdmin
```

Rescue and transfer tokens locked in this contract.

#### Input Parameters:

| Name   | Type      | Description                                    |
| :----- | :-------- | :--------------------------------------------- |
| token   | `address` | The address of the token |
| to   | `address` | The address of the recipient |
| amount   | `uint256` | The amount of token to transfer |

## View Methods
  
### balanceOf

```solidity
function balanceOf(address user)
    public
    view
    virtual
    override(IncentivizedERC20, IERC20)
    returns (uint256)
```

Returns the amount of tokens owned by `user`.

Overrides the base function.

#### Input Parameters:

| Name    | Type      | Description                 |
| :------ | :-------- | :-------------------------- |
| user | `address` | The address of the user |

#### Return Values:

| Type      | Description                             |
| :-------- | :-------------------------------------- |
| `uint256` | The amount of tokens owned by `user` |

### totalSupply

```solidity
function totalSupply() public view virtual override(IncentivizedERC20, IERC20 returns (uint256) 
```

Returns the amount of tokens in existence.

Overrides the base function

#### Return Values:

| Type      | Description                       |
| :-------- | :-------------------------------- |
| `uint256` | The amount of tokens in existence |

### RESERVE_TREASURY_ADDRESS

```solidity
function RESERVE_TREASURY_ADDRESS() external view override returns (address)
```

Returns the address of the Aave treasury, controlled by governance, receiving the fees on this aToken.

#### Return Values:

| Type      | Description                      |
| :-------- | :------------------------------- |
| `address` | The address of the Aave treasury |

### UNDERLYING_ASSET_ADDRESS

```solidity
function UNDERLYING_ASSET_ADDRESS() external view override returns (address)
```

Returns the address of the underlying reserve asset of this aToken (E.g. WETH for aWETH).

#### Return Values:

| Type      | Description                         |
| :-------- | :---------------------------------- |
| `address` | The address of the underlying asset |

### DOMAIN_SEPARATOR

```solidity
function DOMAIN_SEPARATOR() public view override(IAToken, EIP712Base) returns (bytes32)
```
Get the domain separator for the token at the current chain.

Return cached value if chainId matches cache, otherwise recomputes separator.

Overrides the base function to fully implement IAToken.

#### Return Values:

| Type      | Description                         |
| :-------- | :---------------------------------- |
| `bytes32` | The domain separator of the token at current chain |  

### nonces

```solidity
function nonces(address owner) public view override(IAToken, EIP712Base) returns (uint256)
```

Returns the nonce value for address specified as parameter. This is the nonce used when calling `permit()`.

Overrides the base function to fully implement IAToken.

#### Input Parameters:

| Name    | Type      | Description                 |
| :------ | :-------- | :-------------------------- |
| owner | `address` | The address of the owner |

#### Return Values:

| Type      | Description                             |
| :-------- | :-------------------------------------- |
| `uint256` | The nonce of the owner |

```jsx
const token = new Contract(aTokenAddres, aToken.abi, provider);
await token.nonces(user);
```

## Pure Methods

### getRevision

```solidity
function getRevision() internal pure virtual override returns (uint256)
```

Returns the revision number of the contract. Needs to be defined in the inherited class as a constant.

Returns `0x1`.

#### Return Values:

| Type      | Description         |
| :-------- | :------------------ |
| `uint256` | The revision number | 